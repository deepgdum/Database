from fastapi import FastAPI
from pydantic import BaseModel
import psycopg2
import pandas as pd
from fastapi.responses import JSONResponse
from psycopg2 import sql as psycopg2_sql

app = FastAPI()

# PostgreSQL connection settings
DB_CONFIG = {
    "host": "dpg-d0necthr0fns738ula70-a",
    "port": 5432,
    "database": "nocodeql_demo",
    "user": "nocodeql_demo_user",
    "password": "EkHW4T1ToLLTDGXPhAvZhbzEE2zAtEae"
}

# Request body format
class QueryRequest(BaseModel):
    sql: str

@app.post("/run-sql")
def run_sql(request: QueryRequest):
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        df = pd.read_sql_query(request.sql, conn)
        conn.close()
        return {"result": df.to_dict(orient="records")}
    except Exception as e:
        return {"error": str(e)}

@app.get("/init-db")
def init_db():
    try:
        conn = psycopg2.connect(**DB_CONFIG)
        cur = conn.cursor()


        # Drop tables if they exist
        cur.execute("DROP TABLE IF EXISTS users CASCADE;")
        cur.execute("DROP TABLE IF EXISTS orders CASCADE;")
        cur.execute("DROP TABLE IF EXISTS sales CASCADE;")
        cur.execute("DROP TABLE IF EXISTS products CASCADE;")
        cur.execute("DROP TABLE IF EXISTS customers CASCADE;")


        # Create customers table
        cur.execute("""
        CREATE TABLE customers (
            customer_key INT PRIMARY KEY,
            customer_id INT,
            customer_number VARCHAR(50),
            first_name VARCHAR(50),
            last_name VARCHAR(50),
            country VARCHAR(50),
            marital_status VARCHAR(50),
            gender VARCHAR(50),
            birthdate DATE,
            create_date DATE
        );
        """)

        # Create products table
        cur.execute("""
        CREATE TABLE products (
            product_key INT PRIMARY KEY,
            product_id INT,
            product_number VARCHAR(50),
            product_name VARCHAR(50),
            category_id VARCHAR(50),
            category VARCHAR(50),
            subcategory VARCHAR(50),
            maintenance VARCHAR(50),
            cost INT,
            product_line VARCHAR(50),
            start_date DATE
        );
        """)

        # Create sales table
        cur.execute("""
        CREATE TABLE sales (
            order_number VARCHAR(50) PRIMARY KEY,
            product_key INT,
            customer_key INT,
            order_date DATE,
            shipping_date DATE,
            due_date DATE,
            sales_amount INT,
            quantity SMALLINT,
            price INT,
            FOREIGN KEY (product_key) REFERENCES products(product_key),
            FOREIGN KEY (customer_key) REFERENCES customers(customer_key)
        );
        """)

        # Insert customers
        cur.execute("""
        INSERT INTO customers (customer_key, customer_id, customer_number, first_name, last_name, country, marital_status, gender, birthdate, create_date) VALUES
        (11000, 11000, 'AW00011000', 'Jon', 'Yang', 'Australia', 'Married', 'Male', '1971-10-06', '2025-10-06'),
        (11001, 11001, 'AW00011001', 'Eugene', 'Huang', 'Australia', 'Single', 'Male', '1976-05-10', '2025-10-06'),
        (11002, 11002, 'AW00011002', 'Ruben', 'Torres', 'Australia', 'Married', 'Male', '1971-02-09', '2025-10-06'),
        (11003, 11003, 'AW00011003', 'Christy', 'Zhu', 'Australia', 'Single', 'Female', '1973-08-14', '2025-10-06'),
        (11004, 11004, 'AW00011004', 'Elizabeth', 'Johnson', 'Australia', 'Single', 'Female', '1979-08-05', '2025-10-06'),
        (11005, 11005, 'AW00011005', 'Julio', 'Ruiz', 'Australia', 'Single', 'Male', '1976-08-01', '2025-10-06'),
        (11006, 11006, 'AW00011006', 'Janet', 'Alvarez', 'Australia', 'Single', 'Female', '1976-12-02', '2025-10-06'),
        (11007, 11007, 'AW00011007', 'Marco', 'Mehta', 'Australia', 'Married', 'Male', '1969-11-06', '2025-10-06'),
        (11008, 11008, 'AW00011008', 'Rob', 'Verhoff', 'Australia', 'Single', 'Female', '1975-07-04', '2025-10-06'),
        (11009, 11009, 'AW00011009', 'Shannon', 'Carlson', 'Australia', 'Single', 'Male', '1969-09-29', '2025-10-06'),
        (11010, 11010, 'AW00011010', 'Jacquelyn', 'Suarez', 'Australia', 'Single', 'Female', '1969-08-05', '2025-10-06'),
        (11011, 11011, 'AW00011011', 'Curtis', 'Lu', 'Australia', 'Married', 'Male', '1969-05-03', '2025-10-06'),
        (11012, 11012, 'AW00011012', 'Lauren', 'Walker', 'United States', 'Married', 'Female', '1979-01-14', '2025-10-06'),
        (11013, 11013, 'AW00011013', 'Ian', 'Jenkins', 'United States', 'Married', 'Male', '1979-08-03', '2025-10-06'),
        (11014, 11014, 'AW00011014', 'Sydney', 'Bennett', 'United States', 'Single', 'Female', '1973-11-06', '2025-10-06'),
        (11015, 11015, 'AW00011015', 'Chloe', 'Young', 'United States', 'Single', 'Female', '1984-08-26', '2025-10-06'),
        (11016, 11016, 'AW00011016', 'Wyatt', 'Hill', 'United States', 'Married', 'Male', '1984-10-25', '2025-10-07'),
        (11017, 11017, 'AW00011017', 'Shannon', 'Wang', 'Australia', 'Single', 'Female', '1949-12-24', '2025-10-07'),
        (11018, 11018, 'AW00011018', 'Clarence', 'Rai', 'Australia', 'Single', 'Male', '1955-10-06', '2025-10-07'),
        (11019, 11019, 'AW00011019', 'Luke', 'Lal', 'Canada', 'Single', 'Male', '1983-09-04', '2025-10-07'),
        (11020, 11020, 'AW00011020', 'Jordan', 'King', 'Canada', 'Single', 'Male', '1984-03-19', '2025-10-07'),
        (11021, 11021, 'AW00011021', 'Destiny', 'Wilson', 'United States', 'Single', 'Female', '1984-03-02', '2025-10-07'),
        (11022, 11022, 'AW00011022', 'Ethan', 'Zhang', 'United States', 'Married', 'Male', '1984-04-10', '2025-10-07'),
        (11023, 11023, 'AW00011023', 'Seth', 'Edwards', 'United States', 'Married', 'Male', '1984-04-09', '2025-10-07'),
        (11024, 11024, 'AW00011024', 'Russell', 'Xie', 'United States', 'Married', 'Male', '1984-03-16', '2025-10-07'),
        (11025, 11025, 'AW00011025', 'Alejandro', 'Beck', 'Australia', 'Married', 'Male', '1951-06-22', '2025-10-07'),
        (11026, 11026, 'AW00011026', 'Harold', 'Sai', 'Australia', 'Single', 'Male', '1951-10-01', '2025-10-07'),
        (11027, 11027, 'AW00011027', 'Jessie', 'Zhao', 'Australia', 'Married', 'Male', '1952-06-05', '2025-10-07'),
        (11028, 11028, 'AW00011028', 'Jill', 'Jimenez', 'Australia', 'Married', 'Female', '1951-10-09', '2025-10-07'),
        (11029, 11029, 'AW00011029', 'Jimmy', 'Moreno', 'Australia', 'Married', 'Male', '1952-06-19', '2025-10-07'),
        (11030, 11030, 'AW00011030', 'Bethany', 'Yuan', 'Australia', 'Married', 'Female', '1958-02-18', '2025-10-07'),
        (11031, 11031, 'AW00011031', 'Theresa', 'Ramos', 'Australia', 'Married', 'Female', '1953-02-18', '2025-10-07'),
        (11032, 11032, 'AW00011032', 'Denise', 'Stone', 'Australia', 'Married', 'Female', '1952-12-08', '2025-10-07'),
        (11033, 11033, 'AW00011033', 'Jaime', 'Nath', 'Australia', 'Married', 'Male', '1958-09-19', '2025-10-07'),
        (11034, 11034, 'AW00011034', 'Ebony', 'Gonzalez', 'Australia', 'Married', 'Female', '1952-12-16', '2025-10-07'),
        (11035, 11035, 'AW00011035', 'Wendy', 'Dominguez', 'Australia', 'Married', 'Female', '1953-08-23', '2025-10-07'),
        (11036, 11036, 'AW00011036', 'Jennifer', 'Russell', 'United States', 'Married', 'Female', '1984-06-16', '2025-10-07'),
        (11037, 11037, 'AW00011037', 'Chloe', 'Garcia', 'Canada', 'Single', 'Female', '1983-05-27', '2025-10-07'),
        (11038, 11038, 'AW00011038', 'Diana', 'Hernandez', 'Australia', 'Married', 'Female', '1953-09-20', '2025-10-07'),
        (11039, 11039, 'AW00011039', 'Marc', 'Martin', 'Australia', 'Married', 'Male', '1954-06-09', '2025-10-07'),
        (11040, 11040, 'AW00011040', 'Jesse', 'Murphy', 'United States', 'Married', 'Male', '1983-01-29', '2025-10-07'),
        (11041, 11041, 'AW00011041', 'Amanda', 'Carter', 'United States', 'Married', 'Female', '1983-04-15', '2025-10-07'),
        (11042, 11042, 'AW00011042', 'Megan', 'Sanchez', 'United States', 'Married', 'Female', '1982-12-11', '2025-10-07'),
        (11043, 11043, 'AW00011043', 'Nathan', 'Simmons', 'United States', 'Married', 'Male', '1981-08-23', '2025-10-07'),
        (11044, 11044, 'AW00011044', 'Adam', 'Flores', 'Australia', 'Married', 'Male', '1954-11-21', '2025-10-07'),
        (11045, 11045, 'AW00011045', 'Leonard', 'Nara', 'Australia', 'Single', 'Male', '1955-11-16', '2025-10-07'),
        (11046, 11046, 'AW00011046', 'Christine', 'Yuan', 'Australia', 'Married', 'Female', '1955-09-19', '2025-10-07'),
        (11047, 11047, 'AW00011047', 'Jaclyn', 'Lu', 'Australia', 'Married', 'Female', '1955-08-27', '2025-10-07'),
        (11048, 11048, 'AW00011048', 'Jeremy', 'Powell', 'Australia', 'Married', 'Male', '1956-05-21', '2025-10-07'),
        (11049, 11049, 'AW00011049', 'Carol', 'Rai', 'United States', 'Single', 'Female', '1986-01-15', '2025-10-07');
        """)

        # Insert products
        cur.execute("""
        INSERT INTO products (product_key, product_id, product_number, product_name, category_id, category, subcategory, maintenance, cost, product_line, start_date) VALUES
        (100, 100, 'P100', 'Laptop Pro X', 'CAT01', 'Electronics', 'Computers', 'Yes', 1200, 'Premium Line', '2022-01-01'),
        (101, 101, 'P101', 'Smartphone Z', 'CAT01', 'Electronics', 'Mobiles', 'No', 800, 'Standard Line', '2022-03-15'),
        (102, 102, 'P102', 'Wireless Mouse', 'CAT02', 'Accessories', 'Input Devices', 'No', 40, 'Basic Line', '2022-02-20'),
        (103, 103, 'P103', 'Mechanical Keyboard', 'CAT02', 'Accessories', 'Input Devices', 'Yes', 100, 'Premium Line', '2022-05-10'),
        (104, 104, 'P104', '4K Monitor', 'CAT03', 'Displays', 'Monitors', 'Yes', 300, 'Pro Line', '2022-04-01'),
        (105, 105, 'P105', 'USB-C Hub', 'CAT04', 'Accessories', 'Adapters', 'No', 60, 'Standard Line', '2022-06-01');
        """)

        # Insert sales
        cur.execute("""
        INSERT INTO sales (order_number, product_key, customer_key, order_date, shipping_date, due_date, sales_amount, quantity, price) VALUES
        ('ORD001', 105, 11018, '2024-02-04', '2024-02-07', '2024-02-13', 120, 2, 60),
        ('ORD002', 100, 11035, '2024-08-22', '2024-08-25', '2024-08-31', 3600, 3, 1200),
        ('ORD003', 101, 11047, '2024-08-13', '2024-08-14', '2024-08-19', 2400, 3, 800),
        ('ORD004', 100, 11003, '2024-03-20', '2024-03-23', '2024-03-28', 6000, 5, 1200),
        ('ORD005', 100, 11024, '2024-10-16', '2024-10-19', '2024-10-28', 4800, 4, 1200),
        ('ORD006', 103, 11009, '2024-04-23', '2024-04-25', '2024-05-01', 200, 2, 100),
        ('ORD007', 100, 11033, '2024-02-14', '2024-02-17', '2024-02-27', 1200, 1, 1200),
        ('ORD008', 105, 11029, '2024-06-03', '2024-06-05', '2024-06-13', 240, 4, 60),
        ('ORD009', 100, 11042, '2024-10-16', '2024-10-19', '2024-10-27', 6000, 5, 1200),
        ('ORD010', 101, 11032, '2024-07-05', '2024-07-07', '2024-07-12', 3200, 4, 800),
        ('ORD011', 100, 11021, '2024-02-23', '2024-02-24', '2024-03-03', 6000, 5, 1200),
        ('ORD012', 105, 11021, '2024-02-17', '2024-02-18', '2024-02-25', 180, 3, 60),
        ('ORD013', 103, 11028, '2024-06-07', '2024-06-08', '2024-06-16', 200, 2, 100),
        ('ORD014', 100, 11031, '2024-01-01', '2024-01-02', '2024-01-11', 6000, 5, 1200),
        ('ORD015', 104, 11005, '2024-01-04', '2024-01-05', '2024-01-10', 600, 2, 300),
        ('ORD016', 105, 11023, '2024-02-15', '2024-02-17', '2024-02-26', 240, 4, 60),
        ('ORD017', 104, 11010, '2024-07-25', '2024-07-28', '2024-08-03', 1200, 4, 300),
        ('ORD018', 100, 11018, '2024-06-11', '2024-06-12', '2024-06-17', 2400, 2, 1200),
        ('ORD019', 102, 11004, '2024-06-26', '2024-06-29', '2024-07-09', 160, 4, 40),
        ('ORD020', 105, 11037, '2024-01-01', '2024-01-02', '2024-01-07', 240, 4, 60),
        ('ORD021', 102, 11004, '2024-05-22', '2024-05-23', '2024-05-29', 160, 4, 40),
        ('ORD022', 104, 11026, '2024-07-03', '2024-07-06', '2024-07-12', 900, 3, 300),
        ('ORD023', 105, 11027, '2024-07-07', '2024-07-09', '2024-07-16', 300, 5, 60),
        ('ORD024', 103, 11030, '2024-09-13', '2024-09-15', '2024-09-21', 300, 3, 100),
        ('ORD025', 103, 11042, '2024-06-06', '2024-06-08', '2024-06-14', 300, 3, 100),
        ('ORD026', 102, 11004, '2024-06-06', '2024-06-07', '2024-06-12', 160, 4, 40),
        ('ORD027', 105, 11037, '2024-09-28', '2024-09-30', '2024-10-10', 180, 3, 60),
        ('ORD028', 103, 11038, '2024-08-12', '2024-08-14', '2024-08-20', 300, 3, 100),
        ('ORD029', 100, 11022, '2024-04-21', '2024-04-22', '2024-04-27', 1200, 1, 1200),
        ('ORD030', 101, 11011, '2024-05-20', '2024-05-21', '2024-05-27', 1600, 2, 800),
        ('ORD031', 104, 11007, '2024-04-03', '2024-04-04', '2024-04-14', 300, 1, 300),
        ('ORD032', 102, 11042, '2024-01-24', '2024-01-25', '2024-02-04', 80, 2, 40),
        ('ORD033', 101, 11048, '2024-08-03', '2024-08-04', '2024-08-13', 1600, 2, 800),
        ('ORD034', 104, 11037, '2024-06-20', '2024-06-22', '2024-06-27', 1200, 4, 300),
        ('ORD035', 103, 11025, '2024-07-28', '2024-07-29', '2024-08-07', 300, 3, 100),
        ('ORD036', 104, 11006, '2024-07-23', '2024-07-24', '2024-08-01', 1200, 4, 300),
        ('ORD037', 103, 11031, '2024-05-09', '2024-05-11', '2024-05-17', 500, 5, 100),
        ('ORD038', 102, 11035, '2024-05-07', '2024-05-10', '2024-05-17', 40, 1, 40),
        ('ORD039', 103, 11049, '2024-02-19', '2024-02-20', '2024-02-25', 300, 3, 100),
        ('ORD040', 102, 11015, '2024-08-03', '2024-08-05', '2024-08-11', 80, 2, 40),
        ('ORD041', 103, 11035, '2024-06-12', '2024-06-14', '2024-06-22', 300, 3, 100),
        ('ORD042', 100, 11001, '2024-01-01', '2024-01-04', '2024-01-12', 2400, 2, 1200),
        ('ORD043', 105, 11044, '2024-06-08', '2024-06-11', '2024-06-19', 180, 3, 60),
        ('ORD044', 104, 11005, '2024-08-10', '2024-08-13', '2024-08-21', 900, 3, 300),
        ('ORD045', 103, 11021, '2024-10-20', '2024-10-22', '2024-10-31', 200, 2, 100),
        ('ORD046', 105, 11029, '2024-05-09', '2024-05-11', '2024-05-20', 300, 5, 60),
        ('ORD047', 104, 11001, '2024-06-21', '2024-06-24', '2024-06-30', 600, 2, 300),
        ('ORD048', 105, 11015, '2024-05-15', '2024-05-16', '2024-05-24', 300, 5, 60),
        ('ORD049', 104, 11039, '2024-04-19', '2024-04-21', '2024-04-27', 1500, 5, 300),
        ('ORD050', 104, 11015, '2024-10-22', '2024-10-23', '2024-11-02', 1500, 5, 300),
        ('ORD051', 101, 11049, '2024-01-11', '2024-01-14', '2024-01-24', 4000, 5, 800),
        ('ORD052', 101, 11031, '2024-10-07', '2024-10-09', '2024-10-18', 4000, 5, 800),
        ('ORD053', 105, 11020, '2024-08-28', '2024-08-31', '2024-09-06', 240, 4, 60),
        ('ORD054', 103, 11028, '2024-09-11', '2024-09-13', '2024-09-21', 200, 2, 100),
        ('ORD055', 100, 11037, '2024-04-13', '2024-04-15', '2024-04-20', 2400, 2, 1200),
        ('ORD056', 102, 11020, '2024-06-25', '2024-06-28', '2024-07-08', 160, 4, 40),
        ('ORD057', 102, 11043, '2024-06-12', '2024-06-13', '2024-06-22', 160, 4, 40),
        ('ORD058', 105, 11019, '2024-06-18', '2024-06-20', '2024-06-29', 300, 5, 60),
        ('ORD059', 105, 11021, '2024-03-02', '2024-03-05', '2024-03-11', 240, 4, 60),
        ('ORD060', 101, 11033, '2024-03-19', '2024-03-21', '2024-03-29', 800, 1, 800),
        ('ORD061', 105, 11001, '2024-01-31', '2024-02-01', '2024-02-07', 120, 2, 60),
        ('ORD062', 100, 11042, '2024-08-19', '2024-08-22', '2024-08-31', 2400, 2, 1200),
        ('ORD063', 103, 11005, '2024-03-08', '2024-03-09', '2024-03-16', 300, 3, 100),
        ('ORD064', 105, 11011, '2024-03-25', '2024-03-26', '2024-04-05', 120, 2, 60),
        ('ORD065', 105, 11021, '2024-03-27', '2024-03-28', '2024-04-06', 300, 5, 60),
        ('ORD066', 105, 11019, '2024-01-13', '2024-01-15', '2024-01-24', 240, 4, 60),
        ('ORD067', 101, 11043, '2024-02-13', '2024-02-14', '2024-02-19', 1600, 2, 800),
        ('ORD068', 104, 11026, '2024-10-10', '2024-10-11', '2024-10-16', 900, 3, 300),
        ('ORD069', 101, 11020, '2024-05-31', '2024-06-02', '2024-06-11', 4000, 5, 800),
        ('ORD070', 102, 11021, '2024-09-03', '2024-09-04', '2024-09-10', 80, 2, 40),
        ('ORD071', 102, 11016, '2024-01-06', '2024-01-08', '2024-01-18', 40, 1, 40),
        ('ORD072', 103, 11035, '2024-03-10', '2024-03-11', '2024-03-20', 300, 3, 100),
        ('ORD073', 100, 11013, '2024-02-04', '2024-02-07', '2024-02-16', 3600, 3, 1200),
        ('ORD074', 105, 11022, '2024-10-05', '2024-10-06', '2024-10-14', 240, 4, 60),
        ('ORD075', 100, 11004, '2024-09-17', '2024-09-20', '2024-09-28', 1200, 1, 1200),
        ('ORD076', 104, 11009, '2024-09-27', '2024-09-30', '2024-10-10', 1500, 5, 300),
        ('ORD077', 102, 11007, '2024-03-10', '2024-03-11', '2024-03-16', 40, 1, 40),
        ('ORD078', 103, 11040, '2024-06-06', '2024-06-07', '2024-06-17', 200, 2, 100),
        ('ORD079', 105, 11043, '2024-01-17', '2024-01-19', '2024-01-24', 180, 3, 60),
        ('ORD080', 100, 11001, '2024-10-13', '2024-10-14', '2024-10-20', 6000, 5, 1200),
        ('ORD081', 105, 11049, '2024-01-20', '2024-01-21', '2024-01-26', 240, 4, 60),
        ('ORD082', 102, 11039, '2024-08-29', '2024-09-01', '2024-09-08', 160, 4, 40),
        ('ORD083', 100, 11016, '2024-03-25', '2024-03-28', '2024-04-05', 2400, 2, 1200),
        ('ORD084', 101, 11016, '2024-07-07', '2024-07-10', '2024-07-19', 800, 1, 800),
        ('ORD085', 105, 11005, '2024-06-14', '2024-06-17', '2024-06-22', 120, 2, 60),
        ('ORD086', 102, 11019, '2024-09-19', '2024-09-22', '2024-09-29', 120, 3, 40),
        ('ORD087', 102, 11024, '2024-05-31', '2024-06-01', '2024-06-10', 160, 4, 40),
        ('ORD088', 105, 11021, '2024-09-01', '2024-09-02', '2024-09-08', 60, 1, 60),
        ('ORD089', 101, 11033, '2024-02-05', '2024-02-06', '2024-02-12', 4000, 5, 800),
        ('ORD090', 103, 11031, '2024-10-04', '2024-10-05', '2024-10-11', 500, 5, 100),
        ('ORD091', 101, 11019, '2024-03-24', '2024-03-27', '2024-04-06', 2400, 3, 800),
        ('ORD092', 101, 11012, '2024-09-14', '2024-09-15', '2024-09-23', 1600, 2, 800),
        ('ORD093', 104, 11009, '2024-08-12', '2024-08-14', '2024-08-20', 1500, 5, 300),
        ('ORD094', 102, 11030, '2024-02-04', '2024-02-05', '2024-02-12', 80, 2, 40),
        ('ORD095', 100, 11034, '2024-07-15', '2024-07-17', '2024-07-25', 6000, 5, 1200),
        ('ORD096', 105, 11041, '2024-05-27', '2024-05-29', '2024-06-06', 300, 5, 60),
        ('ORD097', 105, 11014, '2024-05-09', '2024-05-12', '2024-05-21', 300, 5, 60),
        ('ORD098', 103, 11003, '2024-04-24', '2024-04-25', '2024-05-01', 400, 4, 100),
        ('ORD099', 105, 11028, '2024-01-29', '2024-01-30', '2024-02-09', 180, 3, 60),
        ('ORD100', 105, 11049, '2024-02-03', '2024-02-05', '2024-02-13', 240, 4, 60);
        """)

        conn.commit()
        conn.close()
        return JSONResponse({"message": "✅ Tables created and test data inserted successfully."})

    except Exception as e:
        return JSONResponse({"error": str(e)})
